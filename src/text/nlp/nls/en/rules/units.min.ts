import _ = require("../../../nlp/_");

import data = require('../lexicon/numbers');
declare var r:any;
declare var setToken:any;
declare var countStart:any;
declare var noFallback:any;
declare var zip:any;
zip = { systems: [ 'metric', 'us', 'imperial', 'digital', 'natural' ],
  categories: 
   [ [ 'time' ],
     [ 'mass' ],
     [ 'thermodynamic temperature' ],
     [ 'length' ],
     [ 'area' ],
     [ 'volume' ],
     [ 'information content' ],
     [ 'amount of substance' ],
     [ 'electric current' ],
     [ 'luminous intensity' ],
     [ 'plane angle' ],
     [ 'solid angle' ],
     [ 'energy', 'work', 'heat' ],
     [ 'pressure', 'stress' ],
     [ 'power', 'radiant flux' ],
     [ 'force' ],
     [ 'magnetic flux' ],
     [ 'magnetic field strength', 'magnetic flux density' ],
     [ 'inductance' ],
     [ 'electric charge', 'quantity of electricity' ],
     [ 'voltage',
       'electrical potential difference',
       'electromotive force' ],
     [ 'electric capacitance' ],
     [ 'electric conductance' ],
     [ 'electric resistance', 'impedance', 'reactance' ],
     [ 'frequency' ],
     [ 'illumination' ],
     [ 'luminous flux' ],
     [ 'radioactivity' ],
     [ 'radioactivity absorbed dose' ],
     [ 'radioactivity equivalent dose' ],
     [ 'catalytic activity' ],
     [ 'speed', 'velocity' ],
     [ 'acceleration' ],
     [ 'density' ],
     [ 'mass fraction' ],
     [ 'specific volume' ],
     [ 'magnetic field strength' ],
     [ 'electric current density' ],
     [ 'concentration' ],
     [ 'luminance' ],
     [ 'convergence' ],
     [ 'volumetric flow' ],
     [ 'jerk', 'jolt' ],
     [ 'snap', 'jounce' ],
     [ 'angular velocity' ],
     [ 'momentum', 'impulse' ],
     [ 'angular momentum' ],
     [ 'torque', 'moment of force' ],
     [ 'yank' ],
     [ 'wavenumber',
       'optical power',
       'curvature',
       'spatial frequency' ],
     [ 'area density' ],
     [ 'molar volume' ],
     [ 'action' ],
     [ 'heat capacity', 'entropy' ],
     [ 'molar heat capacity', 'molar entropy' ],
     [ 'specific heat capacity', 'specific entropy' ],
     [ 'molar energy' ],
     [ 'specific energy' ],
     [ 'energy density' ],
     [ 'surface tension', 'stiffness' ],
     [ 'heat flux density', 'irradiance' ],
     [ 'thermal conductivity' ],
     [ 'kinematic viscosity', 'diffusion coefficient' ],
     [ 'dynamic viscosity' ],
     [ 'electric displacement field', 'polarization vector' ],
     [ 'electric charge density' ],
     [ 'conductivity' ],
     [ 'molar conductivity' ],
     [ 'permittivity' ],
     [ 'permeability' ],
     [ 'electric field strength' ],
     [ 'luminous energy' ],
     [ 'luminous exposure' ],
     [ 'X and gamma exposure' ],
     [ 'absorbed dose rate' ],
     [ 'resistivity' ] ],
  tags: [ '', 'nautical', 'historical', 'dry', 'fluid', 'avoirdupois' ],
  prefixes: 
   [ [ 24, 'Y', 'yotta', 80 ],
     [ 21, 'Z', 'zetta', 70 ],
     [ 18, 'E', 'e(?:ks|x)a', 60 ],
     [ 15, 'P', 'peta', 50 ],
     [ 12, 'T', 'te[r]+a', 40 ],
     [ 9, 'G', 'giga', 30 ],
     [ 6, 'M', 'mega', 20 ],
     [ 3, 'k', 'kilo', 10 ],
     [ 2, 'h', 'he[ck]to' ],
     [ 1, 'da', 'de[ck]a' ],
     [ -1, 'd', 'de[cz][yi]' ],
     [ -2, 'c', '[cz]ent[yi]' ],
     [ -3, 'm', 'milli' ],
     [ -6, 'u', '\\u00B5|mikro' ],
     [ -9, 'n', 'nano' ],
     [ -12, 'p', 'pi[ck]o' ],
     [ -15, 'f', 'femto' ],
     [ -18, 'a', 'atto' ],
     [ -21, 'z', 'zepto' ],
     [ -24, 'y', 'yokto' ] ],
  units: 
   [ [ 13, 0, 'bar', 'bar' ],
     [ 6, 3, 'b', 'bit' ],
     [ 3, 1, 'in', 'inch' ],
     [ 6, 3, 'B', 'byte' ],
     [ 7, 0, 'mol', 'mole' ],
     [ 1, 1, 'dr', 'dram' ],
     [ 20, 0, 'V', 'volt' ],
     [ 3, 1, 'yd', 'yard' ],
     [ 3, 1, 'P̸', 'pica' ],
     [ 28, 0, 'Gy', 'gray' ],
     [ 14, 0, 'W', 'watt' ],
     [ 1, 1, 'st', 'stone' ],
     [ 12, 0, 'J', 'joule' ],
     [ 24, 0, 'Hz', 'hertz' ],
     [ 16, 0, 'Wb', 'weber' ],
     [ 17, 0, 'T', 'tesla' ],
     [ 1, 1, 'gr', 'grain' ],
     [ 18, 0, 'H', 'henry' ],
     [ 3, 3, 'px', 'pixel' ],
     [ 21, 0, 'F', 'farad' ],
     [ 30, 0, 'kat', 'katal' ],
     [ 15, 0, 'N', 'newton' ],
     [ 13, 0, 'Pa', 'pascal' ],
     [ 2, 0, '°? ?K', 'kelvin' ],
     [ 40, 0, 'dioptry', 'dioptry' ],
     [ 19, 0, 'C', 'coulomb' ],
     [ 29, 0, 'Sv', 'sievert' ],
     [ 3, 3, 'rem', [ 'root quad (rem)', 'root em' ] ],
     [ 22, 0, 'S', 'siemens' ],
     [ 2, 0, '° ?C', 'celsius', 0, [ 1, 273.15 ] ],
     [ 9, 0, 'cd', 'candela' ],
     [ 1, 1, 'lb', [ 'pound', 'p[fo]und' ] ],
     [ 3, 1, 'mi', [ 'mile', 'me?ill?e' ] ],
     [ 1, 0, 'g', [ 'gram', 'gramm?e?' ], 0, 3 ],
     [ 10, 0, 'rad', [ 'radian', 'radiant?' ] ],
     [ 27, 0, 'Bq', 'becquerel' ],
     [ 2, 1, '° ?F', 'fahrenheit' ],
     [ 1, 1, 'oz', [ 'ounce', '[ou]n[cz]e' ] ],
     [ 23, 0, 'O', [ 'ohm', '\\u2126|ohm' ] ],
     [ 3, 3, 'pt', [ 'point', 'point|punkt' ] ],
     [ 3, 0, 'l', [ 'liter', 'liter|litre' ], 0, 0, 3 ],
     [ 3, 1, 'p', [ 'point', 'point|punkt' ] ],
     [ 1, 1, 'dwt', 'pennyweight' ],
     [ 3, 3, 'em', [ 'quad (em)', 'quad|geviert' ] ],
     [ [ 'thermodynamic temperature by amount of substance' ],
       0,
       0,
       [ 'kelvin mole', 'kelvin mole?' ] ],
     [ 3, 1, 'shot', 'shackle|shot', 1 ],
     [ 1, 1, 'lb t', [ 'troy pound', 'troy p[fo]und' ] ],
     [ 8, 0, 'A', [ 'ampère', 'ampere|ampère' ] ],
     [ 11, 0, 'sr', [ 'steradian', 'st[eé]radiant?' ] ],
     [ 3, 1, 'cb', [ 'cable', 'c[aâ]ble|kabel' ], 1 ],
     [ 3, 0, 'm', [ 'meter', 'meter|m[eè]tre' ] ],
     [ 1, 1, 'oz t', [ 'troy ounce', 'troy [ou]n[cz]e' ] ],
     [ [ 'thermodynamic temperature by mass' ],
       0,
       0,
       [ 'kilogramm? kelvin', 'kilogramm? kelvin' ] ],
     [ 72, 0, 0, [ 'lux second', 'lux se(?:co|ku)nde?' ] ],
     [ 26, 0, 'lm', [ 'lumen', 'lumen|lumina|lumière' ] ],
     [ 52, 0, 0, [ 'joule second', 'joule se(?:co|ku)nde?' ] ],
     [ 71, 0, 0, [ 'lumen second', 'lumen se(?:co|ku)nde?' ] ],
     [ 47, 0, 0, [ 'newton meter', 'newton meter|m[eè]tre' ] ],
     [ 45, 0, 0, [ 'newton second', 'newton se(?:co|ku)nde?' ] ],
     [ 3, 1, 'ft', [ 'foot', 'f(?:oo|ee)t|fu(?:ß|ss)' ] ],
     [ 63, 0, 0, [ 'pascal second', 'pascal se(?:co|ku)nde?' ] ],
     [ 1, 1, 'TON', [ 'ton', '(?:short ?|net ?)?ton[\\W]' ] ],
     [ [ 'length by thermodynamic temperature' ],
       0,
       0,
       [ 'meter kelvin', '(?:meter|m[eè]tre) kelvin' ] ],
     [ 49, 0, 0, [ 'reciprocal meter', 'reciprocal meter|m[eè]tre' ] ],
     [ 3, 1, 'ftm', [ 'fathom', 'fathom|faden|klafter|brasse' ], 1 ],
     [ 1,
       1,
       'cwt',
       [ 'hundredweight', 'hundredweight|cental|zentner' ] ],
     [ 1, 1, 'lTON', [ 'long ton', '(?:long ?|gross |weight )ton' ] ],
     [ 0,
       0,
       'm',
       [ 'minute', 'min\\.?(?:ute(?:[sn]?))?|mikes?' ],
       0,
       [ 60, 0 ] ],
     [ 25, 0, 'lx', [ 'lux', 'lux|beleuchtungsstärke|éclairement' ] ],
     [ 0,
       0,
       'h',
       [ 'hour', 'h\\.?|hr|hrs|hours?|stunden?|heurs?' ],
       0,
       [ 3600, 0 ] ],
     [ 46,
       0,
       0,
       [ 'newton meter second',
         'newton meter|m[eè]tre se(?:co|ku)nde?' ] ],
     [ 0,
       0,
       's',
       [ 'second', 'se[ck]\\.?(?:(?:[ou])nde?)?|\\u0022|\\u2033' ] ],
     [ 1,
       0,
       't',
       [ 'tonne', '(?:metris?ch?e? )?tonne[sn]?(?: métrique)?' ],
       0,
       6 ],
     [ [ 'electric conductance by area' ],
       0,
       0,
       [ 'siemens square meter',
         'siemens (square ?|quadrat ?)?meter|m[eè]tre' ] ],
     [ 3,
       1,
       'nl',
       [ 'nautical mile (nl)',
         'nautical league|nautische liga|ligue nautique' ],
       1 ],
     [ 3,
       1,
       'NM',
       [ 'nautical mile (nmi)',
         '(?:nautical |nautische )me?ile|nmi|mille nautique' ],
       1 ] ],
  pows: 
   { _2: 
      [ 'square ',
        'square|quadrat|centiare|centare|(?:s?q[. ]*)',
        '(?: carr[eé])|(?: squared?)|\\u00B2|2' ],
     _3: 
      [ 'cubic ',
        '[ck]ubi[ck]|(?:[ck]b[. ]*)',
        '(?: cubed?)|\\u00B3|3' ],
     _4: 
      [ 'quartic ',
        'quarti(?:c|que)|biquadratische?|q.',
        '(?: quarti(?:c|que))|\\u2074|4' ],
     length: [ 0, 3, 4, 5 ] },
  per: 
   { _: 'per|pro|a l?|\\/',
     length: { length: 10, time: 31, time_2: 32, time_3: 42, time_4: 43 },
     area: { area: 11, time: 62 },
     mass: { volume: 33, mass: 34, area: 50 },
     volume: { mass: 35, time: 41, 'amount of substance': 51 },
     'plane angle': { time: 44 },
     force: { length: 12, area: 13, time: 48 },
     energy: 
      { time: 14,
        'thermodynamic temperature by amount of substance': 54,
        'thermodynamic temperature by mass': 55,
        'amount of substance': 56,
        mass: 57,
        volume: 58 },
     'electric current': { length: 36, area: 37 },
     'amount of substance': { volume: 38 },
     'luminous intensity': { area: 39 },
     power: { area: 60, 'length by thermodynamic temperature': 61 },
     'electric charge': { area: 64, volume: 65, mass: 73 },
     'electric conductance': { length: 66 },
     'electric conductance by area': { 'amount of substance': 67 },
     'electric capacitance': { length: 68 },
     inductance: { length: 69 },
     voltage: { length: 70 },
     'radioactivity absorbed dose': { time: 74 } },
  by: 
   { _: 'by|\\u22C5|\\u00B7|\\u00D7|\\u2715|\\*',
     force: { time: 45, length: 47 },
     energy: { time: 52, 'thermodynamic temperature': 53 },
     pressure: { time: 63 },
     'luminous flux': { time: 71 },
     illumination: { time: 72 },
     'electric resistance': { length: 75 } },
  numOnly: {},
  prefix: {},
  unit: {},
  numeral: {} }

export = (function () {
    var _u:any = {
      s: zip.units.sort(function(a:any[],bA) { return a[2].length - bA[2].length; }),
      w: zip.units.sort(function(a:any[],bA) { return _.last(a[3]).length - _.last(bA[3]).length; })
    };
    var s = '(?:\\( ?|\\) ?| |$)?', end = '(?:\\b|$)(?: |$)?';
    function prefix(is) { return zip.prefixes.map(function(a){return a[(is==='s') ? 1 : 2];}) }
    function getUnit(is) { return _u[is].map(function(a){return (is==='s') ? a[2] : _.last(a[3]);}) }
    function pows(i){
      return ['(?:(', Object.keys(zip.pows).filter(function(k){return k.substr(0,1) === '_';}).map(function(k){
        return zip.pows[k][i];
      }).join(')|('), '))?'].join('');
    }
    var _nr:any[] = Object.keys(data.multiple).concat(Object.keys(data.tens),Object.keys(data.teens),Object.keys(data.ones));
    zip.numOnly = new RegExp(['(',_nr.join('|'),')',end].join(''), 'gi');
    var nr = ['((?:(?:',_nr.concat(data.plus,data.minus,data.factors,data.decimal,'\\d+').join('|'),')(?: ?))+)'].join('');

    var p = { w:prefix('w'), s:prefix('s'), S: [], W: [] };
    p.W = [{matches: new RegExp(['(',p.w.join(')|('),')'].join(''), 'i')}];
    p.S = [{matches: new RegExp(['(',p.s.join(')|('),')'].join(''), '')}];
    p.fn = {w:_.tokenFn(p, 'W', 1, 1), s:_.tokenFn(p, 'S', 1, 1)}
    zip.prefix = p;

    var u = { w:getUnit('w'), s:getUnit('s'), S: [], W: [] };
    u.W = [{matches: new RegExp(['(',u.w.join(')|('),')'].join(''), 'i')}];
    u.S = [{matches: new RegExp(['(',u.s.join(')|('),')'].join(''), '')}];
    u.fn = {w:_.tokenFn(u, 'W', 1, 1), s:_.tokenFn(u, 'S', 1, 1)};
    zip.units = _u;
    zip.unit = u;

    var pStr = ['(?:(',p.w.join('|'),')|(?:(',p.s.join('|'),')(?=(?:',u.s.join('|'),')(?:',zip.by._,'|',zip.per._,'|\\b|$))))?'].join('');
    var uStr = ['(',u.w.join('|'),')?(?: |$)?(',u.s.join('|'),')?'].join('');

    var unit = [s,pows(1),s,pStr,uStr,s,pows(2),s].join('');
    var a = [
      nr,
      unit,'(',zip.by._,')?',unit,
      '(',zip.per._,')?',s,
      unit,'(',zip.by._,')?',unit,
      end
    ];
    zip.numeral = new RegExp(a.join(''), 'gi');
    return zip;
  })();